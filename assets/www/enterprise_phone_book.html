<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <title>企业通讯录</title>
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />




    <!-- stylesheet lib begin -->
    <link href="css/jquery.mobile.css" rel="stylesheet" type="text/css" />
    <link href="css/jqm-icon-pack-fa.css" rel="stylesheet" type="text/css" />
    <link href="css/public.css" rel="stylesheet" type="text/css" />
    <!-- stylesheet lib end -->
    <!-- stylesheet lib begin-->
    <!--    <script src="javascript/cordova.js" type="text/javascript"></script>-->
    <script src="javascript/jquery.js" type="text/javascript"></script>
    <script src="javascript/jquery.mobile.js" type="text/javascript"></script>

    <!-- stylesheet lib end-->

    <!-- zhiyisoft custom-theme -->
    <link href="css/public.css" rel="stylesheet" type="text/css" />
    <script src="javascript/application.js" type="text/javascript"></script>
    <!-- zhiyisoft custom-theme -->
  </head>
  <body>
    <div data-role="page" id="body">
      <div class="navbar" data-role="header">
	<a href="#" data-rel="back" >后退</a>
	<h2></h2>
      	<a href="#" id="logout" data-role="button" data-icon="delete">退出</a>
	<script type="text/javascript">
    	  $(function(){
	      $("#logout").bind("click",function(){
		  logout();
	      })
	  })
	</script>
      </div>
      <div data-role="content" id="working-area">
	<!-- 企业电话簿  区域-->
	<div id="data-list" data-role="collapsible-set" data-filter="true" data-theme="c" data-content-theme="d">
	</div>

      </div>
      <div data-role="footer" data-position="fixed">
	<div data-role="navbar">
	  <ul>
	  <li><a href="" >按部门</a></li>
	  <li><a href="" >按人员</a></li>
	  </ul>
	</div>
      </div>

    </div>
  </body>


  <script type="text/javascript">
    /*初始化user*/

    $(function(){
	email = localStorage.getItem('email');
	get_servers({
	    url: get_root_organ_path,
	    data: {"email": email},
	    callback: function(data){
		if(data==null){
		    $("#data-list").html("<span style='color:red'>尊敬的用户您好，您暂时尚未加入任何企业，您需要先申请加入企业才能查看详细。</span>")
		}else{
		    $("#body h2").html(data.name)
		    list_children("#body #data-list",data.id)
		}
		}
	    })

    })

    function get_users(dom,organ_id){
	$.ajax({
	    type: "GET",
	    url: get_users_path,
	    data: {"organ_id": organ_id},
	    dataType: "jsonp",
	    jsonp: "callback",
	    success: function(result){
		html="";
//		html+="<div>用户数：<span class='ui-li-count'>"+result.length+"</span></div>"
		html+="<ul data-role='listview' data-split-icon='delete'>";
		for(i in result){
		    html+="<li>";
		    html+="<h3>"+result[i].name+"</h3>"
		    html+="<p>手机:"+result[i].phone+"<a href='tel:"+result[i].phone+"' data-role='button'>点击拨号</a></p>";
		    html+="<p>"+result[i].organname+"</p>";

		    html+="</li>"
		}
		html+="</ul>"
		dom.next("div").html(html)
		$("ul[data-role=listview]").listview();
	    }
	})
    }
   function list_children(dom,organ_id){
	get_servers({
	    url: get_childs_organ_path,
	    data: {"organ_id": organ_id},
	    callback: function(result){
		html="";
		for (i in result){
		    html+="<div data-role='collapsible' data-theme='c' data-content-theme='c'>";
		    if (result[i].child.length==0){
			html+= "<h3  onclick='get_users($(this),"+result[i].id+")'>"+result[i].name+"</h3>";
		    }else{
			html+="<h3>"+result[i].name+"</h3>"
			html+=create_organ_html(result[i].child);
		    }
		    html+="</div>";
		}
		html+="</div>";
	    $(dom).append(html).collapsibleset('refresh')
		    .find('div[data-role=collapsible]').collapsible();
	    }
	})
    }
    function create_organ_html(result){
	html="";
	for (i in result){
	    html+="<div data-role='collapsible' data-theme='c' data-content-theme='c'>";
	    if (result[i].child.length==0){
		html+= "<h3  onclick='get_users($(this),"+result[i].id+")'>"+result[i].name+"</h3>";
	    }else{
		html+="<h3>"+result[i].name+"</h3>"
		html+=create_organ_html(result[i].child);
		}
	    html+="</div>";
	}
	return html;
    }

  </script>
</html>












